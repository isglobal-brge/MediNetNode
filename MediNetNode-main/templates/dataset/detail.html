{% extends 'base.html' %}
{% load static %}

{% block title %}{{ dataset.name }} - Dataset Details{% endblock %}

{% block extra_css %}
<style>
    /* Dataset Detail Specific Styles */
    .info-item {
        background: rgba(0, 0, 0, 0.02);
        border-radius: 8px;
        transition: all 0.2s ease;
    }
    
    .info-item:hover {
        background: rgba(0, 0, 0, 0.04);
        transform: translateX(2px);
    }
    
    .dropdown-menu {
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
    }
    
    .dropdown-item {
        border-radius: 8px;
        margin: 2px 8px;
        transition: all 0.2s ease;
    }
    
    .dropdown-item:hover {
        background-color: rgba(66, 165, 245, 0.1);
        transform: translateX(4px);
    }
    
    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1.2;
        margin-bottom: 0.5rem;
    }
    
    .stat-card-icon {
        width: 60px;
        height: 60px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="modern-card p-3">
                <div class="d-flex justify-content-between align-items-center flex-wrap">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="bi bi-file-earmark-medical text-primary fs-4"></i>
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold">Dataset Details</h6>
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb breadcrumb-sm mb-0">
                                    <li class="breadcrumb-item"><a href="{% url 'dataset:dashboard' %}">Datasets</a></li>
                                    <li class="breadcrumb-item"><a href="{% url 'dataset:list' %}">List</a></li>
                                    <li class="breadcrumb-item active" aria-current="page">{{ dataset.name }}</li>
                                </ol>
                            </nav>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        {% if can_edit %}
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editMetadataModal">
                            <i class="bi bi-pencil me-1"></i> Edit Metadata
                        </button>
                        {% endif %}
                                                 <div class="dropdown">
                             <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="actionDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                 <i class="bi bi-three-dots-vertical"></i>
                             </button>
                             <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0" style="min-width: 200px;">
                                 <li><a class="dropdown-item py-2" href="#"><i class="bi bi-download me-2"></i>Download</a></li>
                                 {% if can_edit %}
                                 <li><a class="dropdown-item py-2" href="#"><i class="bi bi-people me-2"></i>Manage Access</a></li>
                                 <li><hr class="dropdown-divider my-2"></li>
                                 <li>
                                     <a class="dropdown-item py-2 {% if dataset.is_active %}text-danger{% else %}text-success{% endif %}" href="#">
                                         <i class="bi bi-{% if dataset.is_active %}slash-circle{% else %}check-circle{% endif %} me-2"></i>
                                         {% if dataset.is_active %}Deactivate{% else %}Activate{% endif %}
                                     </a>
                                 </li>
                                 {% endif %}
                             </ul>
                         </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row g-4">
        <!-- Left Column - Dataset Info -->
        <div class="col-xl-8">
            <!-- Dataset Information Card -->
            <div class="modern-card mb-4">
                <div class="card-header bg-transparent border-0 p-4 pb-0">
                    <h5 class="card-title fw-bold mb-0">
                        <i class="bi bi-info-circle me-2"></i>Dataset Information
                    </h5>
                </div>
                                 <div class="card-body p-4">
                     <div class="row">
                         <div class="col-md-6">
                             <div class="info-item d-flex justify-content-between align-items-center mb-3 p-3">
                                 <span class="fw-medium text-muted">Name</span>
                                 <span class="fw-semibold">{{ dataset.name }}</span>
                             </div>
                             <div class="info-item d-flex justify-content-between align-items-center mb-3 p-3">
                                 <span class="fw-medium text-muted">Domain</span>
                                 <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2">
                                     <i class="bi bi-tag me-1"></i>{{ dataset.medical_domain|title }}
                                 </span>
                             </div>
                             <div class="info-item d-flex justify-content-between align-items-center mb-3 p-3">
                                 <span class="fw-medium text-muted">Data Type</span>
                                 <span class="fw-semibold">{{ dataset.data_type|title }}</span>
                             </div>
                             <div class="info-item d-flex justify-content-between align-items-center mb-3 p-3">
                                 <span class="fw-medium text-muted">Format</span>
                                 <span class="badge bg-secondary bg-opacity-10 text-secondary px-3 py-2">{{ dataset.file_format|upper }}</span>
                             </div>
                             <div class="info-item d-flex justify-content-between align-items-center mb-3 p-3">
                                 <span class="fw-medium text-muted">Size</span>
                                 <span class="fw-semibold">{{ formatted_size }}</span>
                             </div>
                         </div>
                         <div class="col-md-6">
                             <div class="info-item d-flex justify-content-between align-items-center mb-3 p-3">
                                 <span class="fw-medium text-muted">Uploaded By</span>
                                 <span class="fw-semibold">{{uploaded_by_user }}</span>
                             </div>
                             <div class="info-item d-flex justify-content-between align-items-center mb-3 p-3">
                                 <span class="fw-medium text-muted">Upload Date</span>
                                 <span class="fw-semibold">{{ dataset.uploaded_at|date:"M d, Y H:i" }}</span>
                             </div>
                             <div class="info-item d-flex justify-content-between align-items-center mb-3 p-3">
                                 <span class="fw-medium text-muted">Last Access</span>
                                 <span class="fw-semibold">
                                     {% if dataset.last_accessed %}
                                         {{ dataset.last_accessed|date:"M d, Y H:i" }}
                                     {% else %}
                                         <span class="text-muted">Never</span>
                                     {% endif %}
                                 </span>
                             </div>
                             <div class="info-item d-flex justify-content-between align-items-center mb-3 p-3">
                                 <span class="fw-medium text-muted">Status</span>
                                 <span class="badge bg-{{ dataset.is_active|yesno:'success,danger' }} bg-opacity-10 text-{{ dataset.is_active|yesno:'success,danger' }} px-3 py-2">
                                     <i class="bi bi-{{ dataset.is_active|yesno:'check-circle,x-circle' }} me-1"></i>
                                     {{ dataset.is_active|yesno:'Active,Inactive' }}
                                 </span>
                             </div>
                             {% if dataset.target_column %}
                             <div class="info-item d-flex justify-content-between align-items-center mb-3 p-3">
                                 <span class="fw-medium text-muted">Target Column</span>
                                 <span class="badge bg-warning bg-opacity-10 text-warning px-3 py-2">
                                     <i class="bi bi-bullseye me-1"></i>{{ dataset.target_column }}
                                 </span>
                             </div>
                             {% endif %}
                         </div>
                     </div>
                     {% if dataset.description %}
                     <div class="border-top pt-3 mt-3">
                         <h6 class="fw-semibold mb-2">Description</h6>
                         <p class="mb-0 text-muted">{{ dataset.description|linebreaks }}</p>
                     </div>
                     {% endif %}
                 </div>
            </div>

            <!-- Quality & Security Metrics -->
            <div class="row g-4 mb-4">
                <div class="col-md-4">
                    <div class="modern-card h-100 p-4">
                        <div class="stat-card-icon bg-info bg-opacity-10 text-info">
                            <i class="bi bi-shield-check"></i>
                        </div>
                        <h3 class="stat-number">
                            {% if metadata.data_quality_score %}
                                {{ metadata.data_quality_score }}%
                            {% else %}
                                <span class="text-muted">--</span>
                            {% endif %}
                        </h3>
                        <p class="text-muted mb-0 fw-medium">Data Quality Score</p>
                        <div class="mt-2">
                            <small class="text-info">
                                <i class="bi bi-check-circle"></i> Validated
                            </small>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="modern-card h-100 p-4">
                        <div class="stat-card-icon bg-success bg-opacity-10 text-success">
                            <i class="bi bi-lock"></i>
                        </div>
                        <h3 class="stat-number">
                            {% if metadata.privacy_score %}
                                {{ metadata.privacy_score }}%
                            {% else %}
                                <span class="text-muted">--</span>
                            {% endif %}
                        </h3>
                        <p class="text-muted mb-0 fw-medium">Privacy Score</p>
                        <div class="mt-2">
                            <small class="text-success">
                                <i class="bi bi-shield-check"></i> K-Anonymous: 
                                {% if metadata.k_anonymity_verified %}
                                    <span class="text-success">Yes</span>
                                {% else %}
                                    <span class="text-warning">No</span>
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="modern-card h-100 p-4">
                        <div class="stat-card-icon bg-primary bg-opacity-10 text-primary">
                            <i class="bi bi-database"></i>
                        </div>
                        <h3 class="stat-number">
                            {% if metadata.nulls_verified_zero %}
                                <span class="text-success">0%</span>
                            {% else %}
                                <span class="text-muted">--</span>
                            {% endif %}
                        </h3>
                        <p class="text-muted mb-0 fw-medium">Missing Values</p>
                        <div class="mt-2">
                            <small class="text-primary">
                                <i class="bi bi-check-circle"></i> 
                                {% if metadata.nulls_verified_zero %}
                                    Clean dataset
                                {% else %}
                                    Has missing values
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Metadata Analysis -->
            <div class="modern-card mb-4">
                <div class="card-header bg-transparent border-0 p-4 pb-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title fw-bold mb-0">
                            <i class="bi bi-graph-up me-2"></i>Metadata Analysis
                        </h5>
                        <span class="text-muted small">
                            <i class="bi bi-clock me-1"></i>Last updated: {{ metadata.extraction_timestamp|date:"M d, Y H:i"|default:"--" }}
                        </span>
                    </div>
                </div>
                
                <!-- Debug Info (temporary) -->
                {% if debug %}
                <div class="alert alert-info m-4">
                    <h6><i class="bi bi-info-circle me-2"></i>Debug Information</h6>
                    <p class="mb-2"><strong>Metadata object:</strong> {{ metadata|pprint }}</p>
                    <p class="mb-2"><strong>Statistical Summary:</strong> {{ metadata.statistical_summary|default:"None"|pprint }}</p>
                    <p class="mb-0"><strong>Column Types:</strong> {{ metadata.column_types|default:"None"|pprint }}</p>
                </div>
                {% endif %}
                <div class="card-body p-4">
                    <!-- Statistical Summary -->
                    {% if metadata.statistical_summary %}
                    <div class="mb-4">
                        <h6 class="fw-semibold mb-3">Statistical Summary for {{columns_count}} columns</h6>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th class="border-0 fw-semibold px-3 py-3">Column</th>
                                        <th class="border-0 fw-semibold px-3 py-3">Type</th>
                                        <th class="border-0 fw-semibold px-3 py-3">Mean</th>
                                        <th class="border-0 fw-semibold px-3 py-3">Median</th>
                                        <th class="border-0 fw-semibold px-3 py-3">Std Dev</th>
                                        <th class="border-0 fw-semibold px-3 py-3">P5 - P95</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for column, stats in metadata.statistical_summary.items %}
                                    <tr class="border-bottom border-light">
                                        <td class="py-3 px-3">
                                            <span class="fw-semibold">{{ column }}</span>
                                        </td>
                                        <td class="py-3 px-3">
                                            <span class="badge bg-secondary bg-opacity-10 text-secondary px-2 py-1">
                                                {% if metadata.column_types %}
                                                    {% for col_name, col_type in metadata.column_types.items %}
                                                        {% if col_name == column %}{{ col_type }}{% endif %}
                                                    {% endfor %}
                                                {% else %}
                                                    numeric
                                                {% endif %}
                                            </span>
                                        </td>
                                        <td class="py-3 px-3">
                                            <span class="fw-medium">{{ stats.mean|floatformat:2 }}</span>
                                        </td>
                                        <td class="py-3 px-3">
                                            <span class="fw-medium">{{ stats.median|floatformat:2 }}</span>
                                        </td>
                                        <td class="py-3 px-3">
                                            <span class="text-muted">{{ stats.std|floatformat:2 }}</span>
                                        </td>
                                        <td class="py-3 px-3">
                                            <span class="text-muted small">{{ stats.p5|floatformat:1 }} - {{ stats.p95|floatformat:1 }}</span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-graph-up display-4 mb-3"></i>
                        <h5>No Statistical Data Available</h5>
                        <p class="mb-0">Statistical analysis has not been performed on this dataset yet.</p>
                    </div>
                    {% endif %}

                   
                </div>
            </div>
        </div>

        <!-- Right Column - Stats & Access -->
        <div class="col-xl-4">
            <!-- Usage Statistics -->
            <div class="modern-card mb-4">
                <div class="card-header bg-transparent border-0 p-4 pb-0">
                    <h5 class="card-title fw-bold mb-0">
                        <i class="bi bi-bar-chart me-2"></i>Usage Statistics
                    </h5>
                </div>
                <div class="card-body">
                    <div class="status-item d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center">
                            <div class="status-icon bg-primary bg-opacity-10 text-primary rounded-circle p-2 me-3">
                                <i class="bi bi-eye"></i>
                            </div>
                            <span class="fw-medium">Total Accesses</span>
                        </div>
                        <span class="h5 fw-bold text-primary mb-0">{{ stats.total_accesses|default:"0" }}</span>
                    </div>
                    
                    <div class="status-item d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center">
                            <div class="status-icon bg-success bg-opacity-10 text-success rounded-circle p-2 me-3">
                                <i class="bi bi-people"></i>
                            </div>
                            <span class="fw-medium">Unique Users</span>
                        </div>
                        <span class="h5 fw-bold text-success mb-0">{{ stats.unique_users|default:"0" }}</span>
                    </div>
                    
                    <div class="status-item d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <div class="status-icon bg-info bg-opacity-10 text-info rounded-circle p-2 me-3">
                                <i class="bi bi-calendar"></i>
                            </div>
                            <span class="fw-medium">Days Since Upload</span>
                        </div>
                        <span class="h5 fw-bold text-info mb-0">{{ stats.days_since_upload|default:"0" }}</span>
                    </div>

                    <!-- Quick Stats Section -->
                    <div class="border-top pt-3 pb-2">
                        <div class="row text-center">
                            <div class="col-6 border-end">
                                <div class="h6 fw-bold text-warning mb-1">{{ stats.daily_avg|default:"0" }}</div>
                                <div class="small text-muted">Daily Avg</div>
                            </div>
                            <div class="col-6">
                                <div class="h6 fw-bold text-secondary mb-1">{{ stats.weekly_growth|default:"0" }}%</div>
                                <div class="small text-muted">Weekly Growth</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Access -->
            <div class="modern-card">
                <div class="card-header bg-transparent border-0 p-4 pb-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title fw-bold mb-0">
                            <i class="bi bi-clock-history me-2"></i>Recent Access
                        </h5>
                        <a href="#" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-list-ul me-1"></i>View All
                        </a>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div style="max-height: 320px; overflow-y: auto;" class="px-4 py-3">
                        {% for access in access_history %}
                        <div class="activity-item d-flex align-items-start {% if not forloop.last %}border-bottom{% endif %} pb-3 mb-3">
                            <div class="activity-icon me-3 mt-1">
                                <div class="bg-primary bg-opacity-10 text-primary rounded-circle p-2">
                                    <i class="bi bi-person-check"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <div class="fw-medium mb-1">{{ access.user.username }}</div>
                                <div class="text-muted small">
                                    <i class="bi bi-person me-1"></i>Granted by {{ access.assigned_by.username }}
                                    <span class="mx-2">â€¢</span>
                                    <i class="bi bi-calendar me-1"></i>{{ access.assigned_at|date:"M d, Y" }}
                                </div>
                                {% if access.expiry_date %}
                                <div class="text-warning small mt-1">
                                    <i class="bi bi-clock me-1"></i>Expires: {{ access.expiry_date|date:"M d, Y" }}
                                </div>
                                {% endif %}
                            </div>
                            <span class="badge bg-success bg-opacity-10 text-success">
                                Active
                            </span>
                        </div>
                        {% empty %}
                        <div class="text-center py-5 text-muted">
                            <i class="bi bi-inbox display-4 mb-3"></i>
                            <p class="mb-0">No access history available</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Metadata Modal -->
{% if can_edit %}
<div class="modal fade" id="editMetadataModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Edit Metadata</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Column Information</label>
                        {{ form.column_info }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Data Types</label>
                        {{ form.data_types }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Missing Values</label>
                        {{ form.missing_values }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Value Ranges</label>
                        {{ form.value_ranges }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Categorical Mappings</label>
                        {{ form.categorical_mappings }}
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Data Quality Score</label>
                                {{ form.data_quality_score }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Privacy Score</label>
                                {{ form.privacy_score }}
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        {{ form.notes }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

 {% block extra_js %}
 <script>
 document.addEventListener('DOMContentLoaded', function() {
     // Debug: Log all data received from Django
     console.log('=== DATASET DETAIL DEBUG ===');
     console.log('Dataset object:', {
         name: '{{ dataset.name }}',
         domain: '{{ dataset.medical_domain }}',
         data_type: '{{ dataset.data_type }}',
         format: '{{ dataset.file_format }}',
         size: '{{ formatted_size }}',
         uploaded_by: '{{ dataset.uploaded_by.username }}',
         uploaded_at: '{{ dataset.uploaded_at|date:"M d, Y H:i" }}',
         last_accessed: '{{ dataset.last_accessed|date:"M d, Y H:i" }}',
         is_active: {{ dataset.is_active|yesno:"true,false" }},
         description: '{{ dataset.description }}'
     });
     
     console.log('Metadata object:', {
         data_quality_score: '{{ metadata.data_quality_score }}',
         privacy_score: '{{ metadata.privacy_score }}',
         k_anonymity_verified: {{ metadata.k_anonymity_verified|yesno:"true,false" }},
         nulls_verified_zero: {{ metadata.nulls_verified_zero|yesno:"true,false" }},
         extraction_timestamp: '{{ metadata.extraction_timestamp }}',
         statistical_summary: '{{ metadata.statistical_summary|default:"None" }}',
         column_types: '{{ metadata.column_types|default:"None" }}'
     });
     
     console.log('Stats object:', {
         total_accesses: '{{ stats.total_accesses|default:"0" }}',
         unique_users: '{{ stats.unique_users|default:"0" }}',
         days_since_upload: '{{ stats.days_since_upload|default:"0" }}',
         daily_avg: '{{ stats.daily_avg|default:"0" }}',
         weekly_growth: '{{ stats.weekly_growth|default:"0" }}'
     });
     
     console.log('Access history:', '{{ access_history|length }} items');
     console.log('Can edit:', {{ can_edit|yesno:"true,false" }});
     console.log('================================');
     
     // Initialize JSON editors
     const jsonFields = ['column_info', 'data_types', 'missing_values', 'value_ranges', 'categorical_mappings'];
     jsonFields.forEach(field => {
         const input = document.getElementById('id_' + field);
         if (input) {
             try {
                 const value = JSON.parse(input.value || '{}');
                 input.value = JSON.stringify(value, null, 2);
             } catch (e) {
                 console.error('Error parsing JSON for field:', field, e);
             }
         }
     });
 });
 </script>
 {% endblock %}
